---
title: "Tratando XML multiref en Biztalk"
layout: post
date: "2013-02-14 09:13:00"
updated: "2014-02-28 12:06:15"
tags: [multiref, XSL, Pipeline, XML, Biztalk]
---

<div class="css-full-post-content js-full-post-content">
<div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-XRewEOvAM04/UxB7pO6R22I/AAAAAAAAtxs/nQX45MgPwdI/s1600/biztalk-logo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-XRewEOvAM04/UxB7pO6R22I/AAAAAAAAtxs/nQX45MgPwdI/s1600/biztalk-logo.png" /></a></div><div class="separator" style="clear: both; text-align: justify;">Atacando un servicio desde Biztalk, me encontré con que este me devolvía el XML en un formato no aceptado por Biztalk. Tenía etiquetas multiref y esto no le gustaba.</div><br /><blockquote class="tr_bq">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;soapenv:Body&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;ns1:sendSmsSubmissionResponse soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/" xmlns:ns1="http://mobicomp.com/smsexpress/webservice/server/message"&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>&lt;sendSmsSubmissionReturn href="#id0" /&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;/ns1:sendSmsSubmissionResponse&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;multiRef id="id0" soapenc:root="0" soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/" xsi:type="ns2:SubmissionStatus" xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:ns2="http://mobicomp.com/smsexpress/webservice/server/message"&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>&lt;id xsi:type="soapenc:string"&gt;4336723&lt;/id&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>&lt;message xsi:type="soapenc:string"&gt;Submisso enviada para processamento.&lt;/message&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>&lt;status href="#id1" /&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;/multiRef&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;multiRef id="id1" soapenc:root="0" soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/" xsi:type="xsd:int" xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"&gt;0&lt;/multiRef&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;/soapenv:Body&gt;<br />&nbsp;&lt;/soapenv:Envelope&gt;</blockquote><br /><br />Para poder tratarlo en Biztalk, tuve que desarollar un pequeño código XSL (stylesheet) que después introduje en la Pipeline de entrada custom para decodificarlo.<br /><br /><blockquote class="tr_bq">&lt;xsl:stylesheet version="1.0"<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns:xsl="http://www.w3.org/1999/XSL/Transform"<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns:ns2="http://mobicomp.com/smsexpress/webservice/server/message"&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;xsl:key name="multiref-by-id" match="multiRef" use="@id"/&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;xsl:template match="/"&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;xsl:copy&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>&lt;xsl:apply-templates select="@* |*"/&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;/xsl:copy&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;/xsl:template&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;xsl:template match="*[starts-with(@href, '#')]"&gt;<br />&nbsp; &nbsp; &lt;xsl:copy&gt; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;xsl:apply-templates select="@* |<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;key('multiref-by-id', substring-after(@href, '#'))/@*[not(local-name()='id' or local-name()='type')] |<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key('multiref-by-id', substring-after(@href, '#'))/node()"/&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;/xsl:copy&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;/xsl:template&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;xsl:template match="@href[starts-with(., '#')] | multiRef[@id] | @soapenc:root"/&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;xsl:template match="@*|node()"&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;xsl:copy&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>&lt;xsl:apply-templates select="@*|node()"/&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;/xsl:copy&gt;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;</blockquote><br /><br />Una vez hecho esto, todo funcionó como la seda. Para el .xsl me inspiré en <a href="http://stackoverflow.com/questions/5185389/creating-xslt-transform-to-flatten-multiref-encoded-soap-message" target="_blank">esta respuesta de StackOverflow</a>
</div>